//
// メイン処理
//
//  DB という struct にメソッドを用意
//  戻り値に 自身のポインターを返すことで、メソッドチェーンを実現
//  可変引数を使って、複数のフィールド(カラム)の処理に対応
//   ※ただし、全てを文字列型として扱ってしまっている。本来は数値などにも対応しなければ


package main

import (
 //"os"
 //"io"
 "fmt"
 "strings"
 //"strconv"
)

// http://play.golang.org/p/zQSEGjZ_3A
type DB struct {
  sql string;
  set bool;
  values bool;
}

func (q *DB)Build(values ...string) string {
  valueCount := len(values)
  pos := -1
  newSQL := ""
  restSQL := q.sql
  for i := 0; i < valueCount; i++ {
    pos = strings.Index(restSQL, "?")
    if pos >= 0 {
      newSQL += restSQL[0 : pos]
      newSQL += values[i]
      restSQL = restSQL[pos+1 : len(restSQL)]
    }
  }
  
  newSQL += restSQL
  return newSQL
}

func (q *DB)Select(fields ...string) *DB {
  q.sql = "SELECT "
  fieldCount := len(fields)
  for i := 0; i < fieldCount; i++ {
    q.sql += fields[i]
    if i < fieldCount - 1 {
      q.sql += ","
    }
    q.sql += " "
  }
  
  return q
}

func (q *DB)From(tables ...string) *DB {
  q.sql += "FROM "
  tableCount := len(tables)
  for i := 0; i < tableCount; i++ {
    q.sql += tables[i]
    if i < tableCount - 1 {
      q.sql += ","
    }
    q.sql += " "
  }
  
  return q
}

func (q *DB)Where(condition string) *DB {
  q.sql += "WHERE "
  q.sql += condition
  q.sql += " "
  
  return q
}

func (q *DB)Insert(table string) *DB {
  q.values = false
  q.sql = "INSERT "
  q.sql += table
  q.sql += " "
  
  return q
}

func (q *DB)Into(fields ...string) *DB {
  q.sql += "INTO ("
  fieldCount := len(fields)
  for i := 0; i < fieldCount; i++ {
    q.sql += fields[i]
    if i < fieldCount - 1 {
      q.sql += ", "
    } else {
      q.sql += ") "
    }
  }
  
  return q
}

func (q *DB)InsertInto(table string, fields ...string) *DB {
  q.values = false
  q.sql = "INSERT INTO "
  q.sql += table
  q.sql += " ("
  fieldCount := len(fields)
  for i := 0; i < fieldCount; i++ {
    q.sql += fields[i]
    if i < fieldCount - 1 {
      q.sql += ", "
    } else {
      q.sql += ") "
    }
  }
  
  return q
}

func (q *DB)Values(values ...string) *DB {
  q.sql += "VALUES ("
  valueCount := len(values)
  for i := 0; i < valueCount; i++ {
    q.sql += ("'" + values[i] + "'")  // Have to remove ' for Number
    if i < valueCount - 1 {
      q.sql += ", "
    } else {
      q.sql += ") "
    }
  }
  
  return q
}

func (q *DB)ValuesN(values ...float64) *DB {
  q.sql += "VALUES ("
  valueCount := len(values)
  for i := 0; i < valueCount; i++ {
    q.sql += fmt.Sprint(values[i])  // remove ' for Number
    if i < valueCount - 1 {
      q.sql += ", "
    } else {
      q.sql += ") "
    }
  }
  
  return q
}


func (q *DB)Update(table string) *DB {
  q.set = false;
  q.sql = "UPDATE "
  q.sql += table
  q.sql += " "
  
  return q
}

func (q *DB)Set(field string, value string) *DB {
  if !q.set {
    q.set = true
    q.sql += "SET "
  } else {
    q.sql = q.sql[0 : len(q.sql)-1]
    q.sql += ", "
  }
  
  q.sql += (field + "='" + value + "' ")   // Have to remove ' for Number
  return q
}

func (q *DB)DeleteFrom(table string) *DB {
  q.sql = "DELETE FROM "
  q.sql += table
  q.sql += " "
  
  return q
}


// --------------------------------------------------------
func main() {
  fmt.Println("goken18 orm query builder")
  //sql := db.Select("id", "name", "email")
  //fmt.Println(sql)
  //fmt.Println("---")
  
  //q := DB{} // 下との違いは？？
  q := &DB{}
  
  // SELECT
  fmt.Println(q.Select("id", "name", "email").Build())
  fmt.Println(q.Select("id", "name", "email").From("users").Build())
  fmt.Println(q.Select("id", "name", "email").From("users", "departments").Build())
  fmt.Println(q.Select("id", "name", "email").From("users", "departments").Where("user.dep = departments.name AND name LIKE 'Mike%'").Build())
  fmt.Println(q.Select("id", "name", "email").From("users").Where("name LIKE 'Mike%'").Build())
  fmt.Println(q.Select("id", "name", "email").From("users").Where("id = '?'").Build("3"))

  // INSERT
  fmt.Println(q.Insert("users").Into("id", "name", "email").Build())
  fmt.Println(q.InsertInto("users", "id", "name", "email").Build())
  fmt.Println(q.Insert("users").Into("id", "name", "email").Values("2123", "Mike Smith", "simth@mail.com").Build())
  fmt.Println(q.InsertInto("users", "id", "name", "email").Values("2123", "Mike Smith", "simth@mail.com").Build())
  fmt.Println(q.InsertInto("users", "id", "name", "email").Values("?", "?", "?").Build("1356", "Tomy John", "tomy@mail.net"))
  // NG fmt.Println(q.InsertInto("users", "id", "name", "age", "email").Values("2123", "Mike Smith", 31, "simth@mail.com").Build())
  
  // UPDATE
  fmt.Println(q.Update("users").Build())
  fmt.Println(q.Update("users").Set("name", "Tomy John").Build())
  fmt.Println(q.Update("users").Set("name", "Tomy John").Set("email", "tomy@mail.net").Build())
  fmt.Println(q.Update("users").Set("name", "Tomy John").Set("email", "tomy@mail.net").Where("id = '3'").Build())
  fmt.Println(q.Update("users").Set("name", "?").Set("email", "?").Where("id = '?'").Build("Tomy John", "tomy@mail.net", "3"))
  
  // DELETE
  fmt.Println(q.DeleteFrom("users").Build())
  fmt.Println(q.DeleteFrom("users").Where("id = '3'").Build())
  fmt.Println(q.DeleteFrom("users").Where("id = '?'").Build("3"))
  
}
